<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FISH Institute – Dashboard</title>

  <style>
    :root{
      --bg1:#f5f5f0;
      --bg2:#e8e3d8;

      --ink:#1b1b1b;
      --stroke: rgba(0,0,0,.14);
      --stroke2: rgba(0,0,0,.10);

      --shadow1: 0 18px 46px rgba(0,0,0,.12);
      --shadow2: 0 6px 16px rgba(0,0,0,.08);

      --coffee:#6F4E37;
      --coffee2:#A67C52;

      --ease-out: cubic-bezier(.16,1,.3,1);
      --ease-inout: cubic-bezier(.4,0,.2,1);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color: var(--ink);
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      overflow-x:hidden;
    }
    body.preloader-on{ overflow:hidden; }

    /* Hide dashboard until welcome is accepted */
    body.dash-hidden .dash{
      opacity:0;
      pointer-events:none;
      transition: opacity 420ms var(--ease-out);
    }
    body:not(.dash-hidden) .dash{
      opacity:1;
      transition: opacity 520ms var(--ease-out);
    }

    .dash{
      max-width:1280px;
      margin:32px auto;
      padding:16px;
    }

    /* ---- Header ---- */
    .dash__header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      margin-bottom:14px;
    }
    .dash__title{
      margin:0;
      font-size:20px;
      font-weight:850;
      letter-spacing:.2px;
    }
    .dash__subtitle{
      margin:6px 0 0 0;
      font-size:13px;
      opacity:.78;
      font-weight:650;
    }
    .dash__meta{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      min-width:260px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.55);
      box-shadow: 0 8px 18px rgba(0,0,0,.06);
      font-size:12px;
      font-weight:800;
      letter-spacing:.02em;
      user-select:none;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background: var(--coffee);
      box-shadow: 0 6px 14px rgba(111,78,55,.22);
      opacity:.95;
    }
    .linkBtn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.72);
      border-radius:999px;
      padding:10px 12px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      color: var(--ink);
      box-shadow: 0 8px 18px rgba(0,0,0,.06);
    }
    .linkBtn:active{ transform: translateY(1px); }

    /* ---- Grid layout: 3 rows × 5 columns ---- */
    .dash__grid{
      display:grid;
      grid-template-columns: 1.2fr 1.2fr 1fr 1fr 1fr; /* C1..C5 */
      grid-template-rows: 180px 280px 210px;         /* R1..R3 */
      gap:12px;
      position:relative;
    }

    /* IMPORTANT: no transforms/filters on tiles/mounts (keeps popups from being "contained") */
    .tile{
      position:relative;
      width:100%;
      height:100%;
      overflow:hidden;
      border-radius:22px;
      background:
        radial-gradient(120% 120% at 20% 10%, rgba(255,255,255,.75), rgba(255,255,255,.34) 55%, rgba(255,255,255,.18) 100%);
      border:1px solid var(--stroke2);
      box-shadow: var(--shadow2);
      transition:
        opacity 520ms var(--ease-out),
        box-shadow 240ms var(--ease-inout);
      transition-delay: calc(var(--i, 0) * 85ms);
    }

    .tile:hover,
    .tile:focus-within{
      z-index: 12;
      box-shadow: var(--shadow1);
    }

    .mount{
      width:100%;
      height:100%;
      opacity: 1;
      transition: opacity 420ms var(--ease-out);
    }

    /* Intro staging */
    body.intro-loading .mount{ opacity: 0; }
    body.intro-loading .tile{ opacity: .92; }
    body.intro-reveal .tile{ opacity: 1; }

    body.intro-settle .tile{
      animation: settleShadow 520ms var(--ease-out) 1;
    }
    @keyframes settleShadow{
      0%   { box-shadow: var(--shadow2); }
      55%  { box-shadow: 0 22px 56px rgba(0,0,0,.13); }
      100% { box-shadow: var(--shadow2); }
    }

    .tile::before{
      content:"";
      position:absolute;
      inset:0;
      opacity:0;
      pointer-events:none;
      background:
        linear-gradient(110deg,
          rgba(255,255,255,.22) 0%,
          rgba(255,255,255,.52) 18%,
          rgba(255,255,255,.22) 38%,
          rgba(255,255,255,.18) 60%,
          rgba(255,255,255,.22) 100%);
      transform: translateX(-40%);
      filter: saturate(.9);
    }
    body.intro-loading .tile::before,
    .tile:not(.is-loaded)::before{
      opacity:.95;
      animation: shimmer 1.25s linear infinite;
    }
    @keyframes shimmer{
      0%{ transform: translateX(-55%); }
      100%{ transform: translateX(55%); }
    }

    #tile-pain.hint-pulse{
      animation: hintPulse 900ms var(--ease-out) 1;
    }
    @keyframes hintPulse{
      0%{ box-shadow: var(--shadow2); border-color: var(--stroke2); }
      45%{
        box-shadow: 0 0 0 3px rgba(111,78,55,.18), var(--shadow1);
        border-color: rgba(111,78,55,.35);
      }
      100%{ box-shadow: var(--shadow2); border-color: var(--stroke2); }
    }

    /* ---- Original placement rules (unchanged) ---- */
    #tile-vitals { grid-column:1; grid-row:1; }
    #tile-coffee { grid-column:2; grid-row:1; }

    #tile-labs{
      grid-column:3 / span 2;
      grid-row:1 / span 2;
      overflow: visible;
    }
    #tile-labs .mount{ height: calc(100% + 2px); }

    #tile-alerts{ grid-column:5; grid-row:1; }

    #tile-prescription{
      grid-column:5;
      grid-row:2;
      display:flex;
      align-items:flex-start;
    }
    #tile-prescription .mount{
      width:100%;
      height:180px;
    }

    #tile-screen{
      grid-column:1 / span 2;
      grid-row:2 / span 2;
    }

    #tile-pain{
      grid-column:3 / span 2;
      grid-row:3;
      display:flex;
      align-items:flex-end;
    }
    #tile-pain .mount{ width:100%; height:auto; }

    #tile-helpline{
      grid-column:5;
      grid-row:3;
      overflow:visible;
    }
    #tile-helpline .mount{
      height:calc(100% + 100px);
      margin-top:-100px;
    }

    /* Let popups escape coffee & pain tiles */
    #tile-coffee{ overflow: visible; }
    #tile-pain{ overflow: visible; }

    @media (max-width: 960px){
      .dash__header{
        flex-direction:column;
        align-items:flex-start;
      }
      .dash__meta{ justify-content:flex-start; min-width:auto; }
    }

    /* ---- Full-screen preloader (3 staged bars) ---- */
    .preload{
      position:fixed;
      inset:0;
      z-index: 200;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      background: rgba(245,245,240,.82);
      backdrop-filter: blur(10px);
      opacity:1;
      transition: opacity 520ms var(--ease-out);
      pointer-events:auto;
    }
    .preload.is-done{
      opacity:0;
      pointer-events:none;
    }

    .preload__card{
      width:min(720px, 94vw);
      border-radius: 28px;
      border:1px solid rgba(0,0,0,.14);
      background: rgba(255,255,255,.82);
      box-shadow: 0 30px 90px rgba(0,0,0,.18);
      padding: 18px 18px 16px;
    }
    .preload__top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      margin-bottom: 10px;
    }
    .preload__brand{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .preload__title{
      margin:0;
      font-size:16px;
      font-weight:950;
      letter-spacing:.02em;
    }
    .preload__subtitle{
      margin:0;
      font-size:12px;
      font-weight:750;
      opacity:.74;
      line-height:1.35;
    }
    .preload__status{
      font-size:12px;
      font-weight:900;
      opacity:.80;
      text-align:right;
      white-space:nowrap;
    }

    .stages{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 10px;
    }
    .stage{
      border-radius: 18px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.55);
      padding: 10px 10px 10px;
    }
    .stage__row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
      margin-bottom: 8px;
    }
    .stage__label{
      font-size:12px;
      font-weight:900;
      letter-spacing:.01em;
    }
    .stage__meta{
      font-size:11px;
      font-weight:900;
      opacity:.70;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.65);
      font-size:10px;
      font-weight:950;
      letter-spacing:.06em;
      text-transform:uppercase;
      min-width:66px;
    }

    .bar{
      height: 10px;
      border-radius: 999px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.55);
      box-shadow: inset 0 1px 0 rgba(0,0,0,.04);
    }
    .bar__fill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(111,78,55,.55), rgba(166,124,82,.62), rgba(111,78,55,.55));
      box-shadow: 0 10px 24px rgba(111,78,55,.16);
    }

    .stage.is-active{
      border-color: rgba(111,78,55,.20);
      box-shadow: 0 0 0 3px rgba(111,78,55,.10);
    }
    .stage.is-done{ opacity:.92; }
    .stage.is-done .badge{
      color: rgba(111,78,55,.95);
      border-color: rgba(111,78,55,.20);
    }

    .preload__foot{
      margin: 12px 0 0 0;
      font-size: 11px;
      font-weight: 800;
      opacity: .65;
    }

    /* ---- Welcome prompt (before dashboard appears) ---- */
    .welcome{
      position:fixed;
      inset:0;
      z-index: 190;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      pointer-events:auto;
    }
    .welcome.is-open{ display:flex; }

    .welcome__backdrop{
      position:absolute;
      inset:0;
      background: rgba(27,27,27,.54);
      backdrop-filter: blur(3px);
      opacity:0;
      transition: opacity 520ms var(--ease-out);
    }
    .welcome.is-open .welcome__backdrop{ opacity:1; }

    .welcome__card{
      position:relative;
      width:min(640px, 92vw);
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.92);
      box-shadow: 0 28px 90px rgba(0,0,0,.30);
      padding: 16px 16px 14px;
      opacity:0;
      transition: opacity 520ms var(--ease-out);
    }
    .welcome.is-open .welcome__card{ opacity:1; }

    .welcome__kicker{
      font-size:11px;
      font-weight:950;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.70;
      margin: 0 0 6px 0;
    }
    .welcome__title{
      margin:0 0 10px 0;
      font-size:15px;
      font-weight:980;
      letter-spacing:.01em;
      line-height:1.35;
    }
    .welcome__actions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top: 8px;
    }
    .welcomeBtn{
      border-radius:999px;
      border:1px solid rgba(0,0,0,.14);
      background:#fff;
      padding:10px 14px;
      font-size:12px;
      font-weight:980;
      letter-spacing:.06em;
      text-transform:uppercase;
      cursor:pointer;
    }
    .welcomeBtn.primary{
      border-color: rgba(111,78,55,.28);
      background: linear-gradient(180deg, #fff, #fff6ee);
      color: var(--coffee);
    }

    /* ---- Quick tour (8 widgets) ---- */
    .tour{
      position:fixed;
      inset:0;
      z-index: 150;
      display:none;
      pointer-events:none;
    }
    .tour.is-open{ display:block; }

    .tour__hole{
      position:absolute;
      border-radius: 22px;
      box-shadow: 0 0 0 9999px rgba(27,27,27,.56);
      outline: 1px solid rgba(255,255,255,.22);
      backdrop-filter: blur(2px);
      transition: left 220ms var(--ease-out), top 220ms var(--ease-out), width 220ms var(--ease-out), height 220ms var(--ease-out);
      pointer-events:none;
    }

    .tour__card{
      position:absolute;
      width: min(380px, 88vw);
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.94);
      box-shadow: 0 24px 70px rgba(0,0,0,.30);
      padding: 12px 12px 10px;
      color: var(--ink);
      pointer-events:auto;
    }
    .tour__kicker{
      font-size:11px;
      font-weight:950;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.70;
      margin: 0 0 6px 0;
    }
    .tour__title{
      margin:0 0 6px 0;
      font-size:14px;
      font-weight:980;
      letter-spacing:.01em;
    }
    .tour__text{
      margin:0 0 10px 0;
      font-size:12px;
      font-weight:800;
      opacity:.86;
      line-height:1.35;
    }
    .tour__actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .tour__step{
      font-size:11px;
      font-weight:950;
      opacity:.65;
      user-select:none;
    }
    .tour__btns{ display:flex; gap:8px; }
    .tourBtn{
      border-radius:999px;
      border:1px solid rgba(0,0,0,.14);
      background:#fff;
      padding:9px 12px;
      font-size:11px;
      font-weight:980;
      letter-spacing:.06em;
      text-transform:uppercase;
      cursor:pointer;
    }
    .tourBtn.primary{
      border-color: rgba(111,78,55,.28);
      background: linear-gradient(180deg, #fff, #fff6ee);
      color: var(--coffee);
    }

    /* ---- Reduced motion ---- */
    @media (prefers-reduced-motion: reduce){
      .tile, .mount, .tour__hole, .preload, .welcome__card, .welcome__backdrop, .dash{
        transition: none !important;
        animation: none !important;
      }
    }
  </style>
</head>

<body class="preloader-on intro-loading dash-hidden">
  <!-- Full staged loading screen -->
  <div class="preload" id="preload" aria-live="polite" aria-label="Loading dashboard">
    <div class="preload__card">
      <div class="preload__top">
        <div class="preload__brand">
          <h1 class="preload__title">FISH Institute</h1>
          <p class="preload__subtitle" id="preloadSubtitle">Warming up the dashboard with absolutely necessary steps.</p>
        </div>
        <div class="preload__status" id="preloadStatus">Starting…</div>
      </div>

      <div class="stages">
        <div class="stage" data-stage="0">
          <div class="stage__row">
            <div class="stage__label">Loading widgets</div>
            <div class="stage__meta"><span class="badge" data-badge>2 sec</span></div>
          </div>
          <div class="bar"><div class="bar__fill" data-fill></div></div>
        </div>

        <div class="stage" data-stage="1">
          <div class="stage__row">
            <div class="stage__label">Finding excuse for why I was so late</div>
            <div class="stage__meta"><span class="badge" data-badge>5 sec</span></div>
          </div>
          <div class="bar"><div class="bar__fill" data-fill></div></div>
        </div>

        <div class="stage" data-stage="2">
          <div class="stage__row">
            <div class="stage__label">Just taking a lil more cause why not :)</div>
            <div class="stage__meta"><span class="badge" data-badge>6 sec</span></div>
          </div>
          <div class="bar"><div class="bar__fill" data-fill></div></div>
        </div>
      </div>

      <p class="preload__foot">Tip: Press “Quick tour” any time.</p>
    </div>
  </div>

  <!-- Welcome prompt (shown after loader, before dashboard appears) -->
  <div class="welcome" id="welcome" aria-hidden="true">
    <div class="welcome__backdrop"></div>
    <div class="welcome__card" role="dialog" aria-modal="true" aria-label="Welcome">
      <div class="welcome__kicker">Welcome</div>
      <div class="welcome__title">Welcome to Shifa Patel's personal dashboard, shall we start with a quick tour?</div>
      <div class="welcome__actions">
        <button class="welcomeBtn primary" id="welcomeSure" type="button">Sure!</button>
      </div>
    </div>
  </div>

  <main class="dash">
    <header class="dash__header">
      <div>
        <h1 class="dash__title">FISH Institute</h1>
        <p class="dash__subtitle">Dashboard overview — today’s snapshot.</p>
      </div>
      <div class="dash__meta">
        <div class="chip"><span class="dot"></span><span>Live view</span></div>
        <button class="linkBtn" id="tourBtn" type="button">Quick tour</button>
      </div>
    </header>

    <section class="dash__grid">
      <div class="tile" id="tile-vitals" style="--i:0">
        <div class="mount" id="mount-vitals"></div>
      </div>

      <div class="tile" id="tile-coffee" style="--i:3">
        <div class="mount" id="mount-coffee"></div>
      </div>

      <div class="tile" id="tile-labs" style="--i:2">
        <div class="mount" id="mount-labs"></div>
      </div>

      <div class="tile" id="tile-alerts" style="--i:1">
        <div class="mount" id="mount-alerts"></div>
      </div>

      <div class="tile" id="tile-screen" style="--i:5">
        <div class="mount" id="mount-screen"></div>
      </div>

      <div class="tile" id="tile-pain" style="--i:6">
        <div class="mount" id="mount-pain"></div>
      </div>

      <div class="tile" id="tile-prescription" style="--i:4">
        <div class="mount" id="mount-prescription"></div>
      </div>

      <div class="tile" id="tile-helpline" style="--i:7">
        <div class="mount" id="mount-helpline"></div>
      </div>
    </section>
  </main>

  <!-- Spotlight Tour -->
  <div class="tour" id="tour" aria-hidden="true">
    <div class="tour__hole" id="tourHole"></div>
    <div class="tour__card" id="tourCard" role="dialog" aria-modal="true" aria-label="Quick tour">
      <div class="tour__kicker">Quick tour</div>
      <div class="tour__title" id="tourTitle">Vitals</div>
      <p class="tour__text" id="tourText">Today’s baseline at a glance.</p>
      <div class="tour__actions">
        <div class="tour__step" id="tourStep">1/8</div>
        <div class="tour__btns">
          <button class="tourBtn" id="tourPrev" type="button">Back</button>
          <button class="tourBtn" id="tourSkip" type="button">Skip</button>
          <button class="tourBtn primary" id="tourNext" type="button">Next</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Animation controller (does not change dashboard.js behavior) -->
  <script>
    (function(){
      const reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      // --- Mount tracking (dashboard.js fills these) ---
      const tiles = Array.from(document.querySelectorAll('.tile'));
      const mounts = tiles.map(t => t.querySelector('.mount')).filter(Boolean);

      const tileByMountId = new Map();
      tiles.forEach(t => {
        const m = t.querySelector('.mount');
        if (m && m.id) tileByMountId.set(m.id, t);
      });

      function mountHasContent(m){
        if (!m) return false;
        if (m.childElementCount > 0) return true;
        const txt = (m.textContent || '').trim();
        return txt.length > 0;
      }

      let loadedCount = 0;

      function markLoaded(tile){
        if (!tile || tile.classList.contains('is-loaded')) return;
        tile.classList.add('is-loaded');

        if (tile.id === 'tile-labs'){
          const pain = document.getElementById('tile-pain');
          if (pain){
            pain.classList.add('hint-pulse');
            setTimeout(() => pain.classList.remove('hint-pulse'), 950);
          }
        }
      }

      function onMountChange(m){
        if (!m || m.dataset._seen === '1') return;
        if (!mountHasContent(m)) return;
        m.dataset._seen = '1';
        loadedCount++;
        markLoaded(tileByMountId.get(m.id));
      }

      mounts.forEach(m => onMountChange(m));

      const obs = new MutationObserver(() => {
        mounts.forEach(m => onMountChange(m));
      });
      obs.observe(document.documentElement, { childList:true, subtree:true });

      // --- Stage 1: Comedic preloader (2s + 5s + 6s) ---
      const preload = document.getElementById('preload');
      const preloadStatus = document.getElementById('preloadStatus');
      const preloadSubtitle = document.getElementById('preloadSubtitle');

      const stageEls = Array.from(document.querySelectorAll('.stage'));
      const fills = stageEls.map(s => s.querySelector('[data-fill]'));

      const stages = [
        { label: 'Loading widgets', ms: 2000 },
        { label: 'Finding excuse for why I was so late', ms: 5000 },
        { label: 'Just taking a lil more cause why not :)', ms: 6000 },
      ];

      function setStageState(i, state){
        const el = stageEls[i];
        if (!el) return;
        el.classList.toggle('is-active', state === 'active');
        el.classList.toggle('is-done', state === 'done');
        const badge = el.querySelector('[data-badge]');
        if (badge){
          badge.textContent = (state === 'done') ? 'Done' : badge.textContent;
        }
      }

      async function runStage(i){
        const s = stages[i];
        const fill = fills[i];

        stageEls.forEach((x, idx) => {
          if (idx < i) setStageState(idx, 'done');
          else if (idx === i) setStageState(idx, 'active');
          else {
            x.classList.remove('is-active','is-done');
            const b = x.querySelector('[data-badge]');
            if (b) b.textContent = stages[idx].ms/1000 + ' sec';
          }
        });

        preloadStatus.textContent = s.label + '…';
        preloadSubtitle.textContent = "Warming up the dashboard with absolutely necessary steps.";

        if (!fill) return;

        fill.style.transition = 'none';
        fill.style.width = '0%';
        void fill.offsetWidth;

        const dur = reduceMotion ? 0 : s.ms;
        fill.style.transition = `width ${dur}ms linear`;
        fill.style.width = '100%';

        await new Promise(res => setTimeout(res, dur));
        setStageState(i, 'done');
      }

      async function runPreloader(){
        if (reduceMotion){
          preloadStatus.textContent = 'Loading completed.';
          stageEls.forEach((_, i) => {
            setStageState(i, 'done');
            if (fills[i]) { fills[i].style.transition = 'none'; fills[i].style.width = '100%'; }
          });
          await new Promise(res => setTimeout(res, 120));
          endPreloader();
          return;
        }

        for (let i=0;i<stages.length;i++){
          await runStage(i);
        }

        preloadStatus.textContent = 'Loading completed.';
        preloadSubtitle.textContent = 'Everything is totally under control.';
        await new Promise(res => setTimeout(res, 800));

        endPreloader();
      }

      // Welcome prompt gate
      const welcome = document.getElementById('welcome');
      const welcomeSure = document.getElementById('welcomeSure');

      function showWelcome(){
        welcome.classList.add('is-open');
        welcome.setAttribute('aria-hidden', 'false');
        try { welcomeSure.focus(); } catch {}
      }

      function hideWelcome(){
        welcome.classList.remove('is-open');
        welcome.setAttribute('aria-hidden', 'true');
      }

      function endPreloader(){
        preload.classList.add('is-done');
        document.body.classList.remove('preloader-on');

        // Keep dashboard hidden; show welcome first (fade-in)
        showWelcome();
      }

      welcomeSure.addEventListener('click', () => {
        hideWelcome();

        // Now let dashboard appear (fade-in) + run reveal + tour
        document.body.classList.remove('dash-hidden');
        startDashboardReveal();
      });

      // Enter/Space triggers “Sure!”
      document.addEventListener('keydown', (e) => {
        if (!welcome.classList.contains('is-open')) return;
        const k = (e.key || '').toLowerCase();
        if (k === 'enter' || k === ' ') {
          e.preventDefault();
          welcomeSure.click();
        }
      }, { passive:false });

      // --- Stage 2: Dashboard reveal (after welcome click) ---
      function startDashboardReveal(){
        const minSkeletonMs = reduceMotion ? 0 : 220;
        const maxWaitMs = 1400;
        const t0 = performance.now();

        function revealNow(){
          document.body.classList.remove('intro-loading');
          document.body.classList.add('intro-reveal');

          if (!reduceMotion){
            setTimeout(() => document.body.classList.add('intro-settle'), 420);
            setTimeout(() => document.body.classList.remove('intro-settle'), 980);
          }

          setTimeout(() => {
            try { obs.disconnect(); } catch {}
            tiles.forEach(t => t.classList.add('is-loaded'));
          }, 2600);

          setTimeout(() => openTour(true), reduceMotion ? 80 : 650);
        }

        function waitThenReveal(){
          const now = performance.now();
          const enoughTime = (now - t0) >= minSkeletonMs;
          const enoughContent = loadedCount >= 2;
          if (enoughTime && (enoughContent || (now - t0) >= maxWaitMs)){
            revealNow();
            return;
          }
          requestAnimationFrame(waitThenReveal);
        }
        requestAnimationFrame(waitThenReveal);
      }

      // --- Stage 3: Quick tour (8 widgets) ---
      const tour = document.getElementById('tour');
      const hole = document.getElementById('tourHole');
      const card = document.getElementById('tourCard');

      const tTitle = document.getElementById('tourTitle');
      const tText  = document.getElementById('tourText');
      const tStep  = document.getElementById('tourStep');

      const btnNext = document.getElementById('tourNext');
      const btnPrev = document.getElementById('tourPrev');
      const btnSkip = document.getElementById('tourSkip');
      const btnOpen = document.getElementById('tourBtn');

      const steps = [
        { sel:'#tile-vitals',        title:'Vitals',            text:"Today’s baseline at a glance." },
        { sel:'#tile-coffee',        title:'Coffee × Mood',      text:"Log mood & caffeine patterns and see correlations." },
        { sel:'#tile-labs',          title:'Lab reports',        text:"Reports and trends — tap to explore details." },
        { sel:'#tile-alerts',        title:'Clinical alerts',    text:"Anything urgent appears here first." },
        { sel:'#tile-screen',        title:'Screen time',        text:"Daily usage breakdown and attention patterns." },
        { sel:'#tile-pain',          title:'Pain assessment',    text:"Track pain score and changes over time." },
        { sel:'#tile-prescription',  title:'Prescription',       text:"Today’s medications and schedule." },
        { sel:'#tile-helpline',      title:'Helpline',           text:"Support contact — quick access when needed." },
      ];
      let stepIdx = 0;

      function setTourOpen(open){
        tour.classList.toggle('is-open', open);
        tour.setAttribute('aria-hidden', open ? 'false' : 'true');
      }

      function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

      function ensureVisible(el){
        try {
          el.scrollIntoView({
            behavior: reduceMotion ? 'auto' : 'smooth',
            block: 'center',
            inline: 'nearest'
          });
        } catch {}
      }

      function chooseCardPosition(holeRect, cardW, cardH){
        const pad = 12;
        const vw = window.innerWidth;
        const vh = window.innerHeight;

        const candidates = [
          { x: holeRect.right + pad, y: holeRect.top },
          { x: holeRect.left - cardW - pad, y: holeRect.top },
          { x: clamp(holeRect.left, pad, vw - cardW - pad), y: holeRect.bottom + pad },
          { x: clamp(holeRect.left, pad, vw - cardW - pad), y: holeRect.top - cardH - pad },
        ];

        function score(pos){
          const x1 = pos.x, y1 = pos.y;
          const x2 = pos.x + cardW, y2 = pos.y + cardH;
          const ix1 = Math.max(pad, x1);
          const iy1 = Math.max(pad, y1);
          const ix2 = Math.min(vw - pad, x2);
          const iy2 = Math.min(vh - pad, y2);
          return Math.max(0, ix2 - ix1) * Math.max(0, iy2 - iy1);
        }

        let best = candidates[0];
        let bestScore = -1;
        for (const c of candidates){
          const s = score(c);
          if (s > bestScore){ bestScore = s; best = c; }
        }

        best.x = clamp(best.x, pad, vw - cardW - pad);
        best.y = clamp(best.y, pad, vh - cardH - pad);
        return best;
      }

      function positionTour(){
        const s = steps[stepIdx];
        const el = document.querySelector(s.sel);
        if (!el) return;

        ensureVisible(el);

        const r = el.getBoundingClientRect();
        const pad = 8;

        const left = clamp(r.left - pad, 8, window.innerWidth - 16);
        const top  = clamp(r.top - pad, 8, window.innerHeight - 16);
        const width = clamp(r.width + pad*2, 0, window.innerWidth - 16);
        const height = clamp(r.height + pad*2, 0, window.innerHeight - 16);

        hole.style.left = left + 'px';
        hole.style.top = top + 'px';
        hole.style.width = width + 'px';
        hole.style.height = height + 'px';

        tTitle.textContent = s.title;
        tText.textContent = s.text;
        tStep.textContent = (stepIdx + 1) + '/' + steps.length;

        btnPrev.disabled = (stepIdx === 0);
        btnNext.textContent = (stepIdx === steps.length - 1) ? 'Done' : 'Next';

        const cardW = Math.min(380, window.innerWidth - 24);
        const cardH = 170;
        const pos = chooseCardPosition({left, top, right:left+width, bottom:top+height}, cardW, cardH);

        card.style.left = pos.x + 'px';
        card.style.top  = pos.y + 'px';
      }

      function openTour(){
        stepIdx = 0;
        setTourOpen(true);
        positionTour();
        window.addEventListener('resize', positionTour, { passive:true });
        window.addEventListener('scroll', positionTour, { passive:true });
        document.addEventListener('keydown', onTourKeydown, { passive:false });
      }

      function closeTour(){
        setTourOpen(false);
        window.removeEventListener('resize', positionTour);
        window.removeEventListener('scroll', positionTour);
        document.removeEventListener('keydown', onTourKeydown);
      }

      function nextTour(){
        if (stepIdx >= steps.length - 1){ closeTour(); return; }
        stepIdx++;
        positionTour();
      }

      function prevTour(){
        if (stepIdx <= 0) return;
        stepIdx--;
        positionTour();
      }

      function onTourKeydown(e){
        if (!tour.classList.contains('is-open')) return;
        const k = (e.key || '').toLowerCase();
        if (k === 'escape'){ e.preventDefault(); closeTour(); }
        else if (k === 'enter' || k === ' ') { e.preventDefault(); nextTour(); }
        else if (k === 'arrowleft') { e.preventDefault(); prevTour(); }
        else if (k === 'arrowright') { e.preventDefault(); nextTour(); }
      }

      btnOpen.addEventListener('click', openTour);
      btnSkip.addEventListener('click', closeTour);
      btnNext.addEventListener('click', nextTour);
      btnPrev.addEventListener('click', prevTour);

      // start
      runPreloader();
    })();
  </script>

  <!-- Keep your existing behavior (unchanged) -->
  <script type="module" src="./dashboard.js"></script>
</body>
</html>
